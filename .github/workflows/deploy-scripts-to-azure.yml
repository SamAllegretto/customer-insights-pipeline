name: Upload Scripts to Azure Storage

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'src/**'
  workflow_dispatch:
    inputs:
      force_upload:
        description: 'Force upload all scripts'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.12'

jobs:
  validate:
    name: Validate All Scripts
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          
          if [ -f requirements.txt ]; then
            echo "ğŸ“¦ Installing dependencies from requirements.txt"
            pip install -r requirements.txt
          else
            echo "ğŸ“¦ Installing basic dependencies for validation"
            pip install pydantic openai pymssql psycopg2-binary numpy scikit-learn
          fi
      
      - name: Lint all scripts
        run: |
          echo "ğŸ” Validating all Python scripts..."
          
          # Find and lint all Python files
          find . -name "*.py" -not -path "./.git/*" -not -path "./.*" -not -path "./.venv/*" -not -path "./venv/*" | \
          xargs flake8 --count --select=E9,F63,F7,F82 --show-source --statistics
          
          echo "âœ… Basic syntax validation passed"
      
      - name: List all scripts to be uploaded
        run: |
          echo "ğŸ“‹ Scripts that will be uploaded:"
          echo "================================"
          
          echo "ğŸ“œ Scripts:"
          find scripts/ -name "*.py" 2>/dev/null | sort || echo "  No scripts found"
          
          echo ""
          echo "ğŸ“š Source Code:"
          find src/ -name "*.py" 2>/dev/null | sort || echo "  No source files found"
      
      - name: Check requirements file
        run: |
          echo "ğŸ“‹ Checking requirements file..."
          
          if [ -f requirements.txt ]; then
            echo "âœ… Found requirements.txt:"
            cat requirements.txt
          else
            echo "âš ï¸  No requirements.txt file found"
          fi

  upload-scripts:
    name: Upload All Scripts to Azure Storage
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Azure CLI and dependencies
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          python -m pip install --upgrade pip
          pip install azure-storage-blob azure-identity
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: false
      
      - name: Verify Azure Login
        run: |
          echo "ğŸ” Verifying Azure login..."
          az account show --output table
          echo "âœ… Azure login successful"
      
      - name: Ensure required containers exist
        run: |
          echo "ğŸ“¦ Ensuring required storage containers exist..."
          
          # Function to create container if it doesn't exist
          create_container_if_not_exists() {
            local container_name=$1
            
            echo "ğŸ” Checking if container '$container_name' exists..."
            
            # Try to create the container using auth-mode login
            if az storage container create \
              --name $container_name \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
              --auth-mode login \
              --output none 2>/dev/null; then
              echo "  âœ… Created '$container_name' container"
            else
              # Container might already exist, let's check
              if az storage container show \
                --name $container_name \
                --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
                --auth-mode login \
                --output none 2>/dev/null; then
                echo "  âœ… '$container_name' container already exists"
              else
                echo "  âŒ Failed to create or verify '$container_name' container"
                exit 1
              fi
            fi
          }
          
          # Create required containers
          create_container_if_not_exists "scripts"
          
          echo "ğŸ“¦ All required containers are ready!"
      
      - name: Upload scripts directory
        run: |
          echo "ğŸ“œ Uploading scripts..."
          
          if [ -d "scripts" ]; then
            find scripts/ -name "*.py" | while read -r file; do
              if [ -f "$file" ]; then
                relative_path=${file#scripts/}
                blob_name="scripts/$relative_path"
                
                echo "ğŸ“¤ Uploading $blob_name..."
                az storage blob upload \
                  --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
                  --container-name scripts \
                  --name "$blob_name" \
                  --file "$file" \
                  --overwrite \
                  --auth-mode login
                
                echo "  âœ… Uploaded $blob_name"
              fi
            done
          else
            echo "  âš ï¸ No scripts folder found"
          fi
      
      - name: Upload source code
        run: |
          echo "ğŸ“š Uploading source code..."
          
          if [ -d "src" ]; then
            find src/ -name "*.py" | while read -r file; do
              if [ -f "$file" ]; then
                relative_path=${file#src/}
                blob_name="src/$relative_path"
                
                echo "ğŸ“¤ Uploading $blob_name..."
                az storage blob upload \
                  --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
                  --container-name scripts \
                  --name "$blob_name" \
                  --file "$file" \
                  --overwrite \
                  --auth-mode login
                
                echo "  âœ… Uploaded $blob_name"
              fi
            done
          else
            echo "  âš ï¸ No src folder found"
          fi
      
      - name: Upload requirements file
        run: |
          echo "ğŸ“¤ Uploading requirements file..."
          
          if [ -f "requirements.txt" ]; then
            az storage blob upload \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
              --container-name scripts \
              --name "requirements.txt" \
              --file "requirements.txt" \
              --overwrite \
              --auth-mode login
            echo "  âœ… Uploaded requirements.txt"
          else
            echo "  âš ï¸  No requirements.txt file found to upload"
          fi
      
      - name: Create script inventory
        run: |
          echo "ğŸ“‹ Creating script inventory for ADF..."
          
          # Create timestamp for versioning
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=${GITHUB_SHA:0:7}
          VERSION="${TIMESTAMP}-${COMMIT_SHA}"
          
          # Create a JSON inventory of all available scripts
          cat > script_inventory.json << EOF
          {
            "version": "$VERSION",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${GITHUB_SHA}",
            "repository": "customer-insights-pipeline",
            "upload_type": "individual_files",
            "storage_structure": {
              "base_url": "https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/scripts",
              "folders": {
                "scripts": "scripts/",
                "src": "src/"
              }
            },
            "pipeline_scripts": $(find scripts/ -name "*.py" 2>/dev/null | sed 's|scripts/||' | sed 's|\.py$||' | jq -R . | jq -s . || echo '[]'),
            "source_modules": $(find src/ -name "*.py" 2>/dev/null | sed 's|src/||' | sed 's|\.py$||' | jq -R . | jq -s . || echo '[]')
          }
          EOF
          
          echo "ğŸ“‹ Script inventory created:"
          cat script_inventory.json | jq .
      
      - name: Upload script inventory
        run: |
          echo "ğŸ“¤ Uploading script inventory..."
          
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --container-name scripts \
            --name "inventory/script_inventory.json" \
            --file "script_inventory.json" \
            --overwrite \
            --auth-mode login
          
          echo "âœ… Script inventory uploaded"
      
      - name: List uploaded files
        run: |
          echo "ğŸ“‹ Listing all uploaded files in storage..."
          az storage blob list \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --container-name scripts \
            --auth-mode login \
            --output table \
            --query "[].{Name:name, Size:properties.contentLength, LastModified:properties.lastModified}"
      
      - name: Summary
        run: |
          echo "ğŸ‰ Script upload completed successfully!"
          echo "=================================="
          echo "ğŸ“ Scripts uploaded as individual files to:"
          echo "  â€¢ scripts/ folder"
          echo "  â€¢ src/ folder"
          echo ""
          echo "ğŸ“‹ Script inventory: inventory/script_inventory.json"
          echo "ğŸ“‹ Requirements file: requirements.txt"
          echo "ğŸ”— Storage URL: https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/scripts/"
          echo ""
          echo "ğŸ¯ Individual files can now be accessed directly in Azure Data Factory!"

  notify:
    name: Notify Upload Status
    runs-on: ubuntu-latest
    needs: [validate, upload-scripts]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Upload Status
        run: |
          if [ "${{ needs.upload-scripts.result }}" == "success" ]; then
            echo "âœ… All scripts uploaded successfully to Azure Storage!"
            echo "ğŸ¯ Ready for use in Azure Data Factory pipelines"
            echo "ğŸ“ Storage Account: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}"
            echo "ğŸ“ Container: scripts/"
            echo "ğŸ“ Files are organized in folders by type (scripts/, src/)"
          else
            echo "âŒ Script upload failed!"
            echo "ğŸ“‹ Check the logs above for details"
          fi
